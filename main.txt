#include <WiFi.h>
#include <HTTPClient.h>

const char* ssid = "One";            // Your WiFi SSID
const char* password = "12345678";   // Your WiFi Password
const char* serverUrl = "http://192.168.43.253:8001/ecg";  // Your Mac IP and FastAPI port

#define ECG_PIN 34
#define LO_Minus_PIN 35
#define LO_Plus_PIN 32

const int ecgPin = ECG_PIN;
const int loPlus = LO_Minus_PIN;
const int loMinus = LO_Plus_PIN;



void setup() {
  Serial.begin(115200);
  WiFi.begin(ssid, password);
  Serial.print("Connecting to WiFi");
  
  while (WiFi.status() != WL_CONNECTED) {
    delay(500);
    Serial.print(".");
  }
  
  Serial.println("\nWiFi connected.");
  Serial.print("ESP IP address: ");
  Serial.println(WiFi.localIP());
}

void loop() {
  if (WiFi.status() == WL_CONNECTED) {
    if (digitalRead(loPlus) == 1 || digitalRead(loMinus) == 1) {
      Serial.println("Leads off");
      continue;
    }
    HTTPClient http;
    http.begin(serverUrl);
    http.addHeader("Content-Type", "application/json");

    // Send dummy timestamp and value
    unsigned long timestamp = millis();
    int value = analogRead(ecgPin);

    String payload = "{\"timestamp\":" + String(timestamp) + ",\"value\":" + String(value) + "}";
    int httpResponseCode = http.POST(payload);

    if (httpResponseCode > 0) {
      Serial.printf("✅ POST Success: %d\n", httpResponseCode);
    } else {
      Serial.printf("❌ POST Error: %s\n", http.errorToString(httpResponseCode).c_str());
    }

    http.end();
  } else {
    Serial.println("⚠️ WiFi not connected");
  }

  delay(20);
}
